{% extends "base_r2.html" %}
{% load i18n %}
{% load staticfiles %}
{% load crispy_forms_tags %}
{% load leaflet_tags %}
{% load thumbnail %}
{% block head %}
{{ block.super }}
{% leaflet_js %}
{% leaflet_css %}

{% endblock head %}
{% block title %}Organisation{% endblock %}

{% block list_of_items %}
<!-- Delete modal -->
<div class="modal fade" id="confirm-delete" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
	  <div class="modal-content">
		<div class="modal-header">
		  <h4 class="modal-title" id="myModalLabel">{% trans "Confirm delete" %}</h4>
		  <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
		</div>
		<div class="modal-body">
		  <p>{% trans "You are going to delete this organisation, this procedure is irreversible." %}</p>
		  <p>{% trans "Do you want to proceed?" %}</p>
		</div>
		<div class="modal-footer">
		  <button type="button" class="btn btn-default" data-dismiss="modal">{% trans "Cancel" %}</button>
		  <a class="btn btn-red btn-delete"><i class="fas fa-trash-alt"></i> {% trans "Delete" %}</a>
		</div>
	  </div>
	</div>
  </div>

  <div class="modal fade" id="confirm-dropout" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
	  <div class="modal-content">
		<div class="modal-header">
		  <h4 class="modal-title" id="myModalLabel">{% trans "Confirm delete" %}</h4>
		  <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
		</div>
		<div class="modal-body">
		  <p>{% trans "You are going to drop out ECSA membership" %}</p>
		  <p>{% trans "Are you sure?" %}</p>
		</div>
		<div class="modal-footer">
		  <button type="button" class="btn btn-default" data-dismiss="modal">{% trans "Cancel" %}</button>
		  <a class="btn btn-red btn-dropout"><i class="fas fa-trash-alt"></i> {% trans "Drop out" %}</a>
		</div>
	  </div>
	</div>
  </div>

{{ permissionForm.media.css }}
<div class="container">
	<div class="card">
		<div class="card-body">
			<div class="row">
				<div class="col-sm-3 col-12">
					<img title="organisation logo" target="_blank"
					class="img-fluid mb-3" src="{{ organisation.logo|default:'/media/default_profile.png' }}">
					<div><strong>Contact Point</strong>: {{ organisation.contactPoint }} </div>
					<div class="mb-5"><strong>{% trans "Contact Point Email" %}</strong>: {{ organisation.contactPointEmail }}</div>
				</div>
				<div class="col-sm-9 col-12">
					<div class="row">
						<div class="col-9">
							<h3>{{ organisation.name }}</h3>
						</div>
						<div class="col-3 text-right">
							<a target="_blank" href="{% if 'http' not in organisation.url %}//{%endif%}{{organisation.url}}"
							class="colorpurple"><i class="fas fa-external-link-square-alt"></i> {% trans "Go to Organisation" %}</a>
						</div>						
					</div>
					
					{{ organisation.description }}
					<br/>
					{% if organisation.ecsa_member %}		
						<a data-href="{% url 'drop_out_ecsa_organisation_membership' organisation.id %}" name='dropoutECSA' data-toggle="modal" data-target="#confirm-dropout"
						class="btn btn-outline btn-red"><i class="fas fa-users"></i> {% trans "Drop out ECSA membership" %}</a>

					{% else %}
						{% if organisation.ecsa_requested_join %}
							<a href="{% url 'claim_ecsa_organisation_payment_revision' organisation.id %}" class="btn btn-outline btn-info"><i class="fas fa-users"></i> {% trans "Claim for ECSA payment revision" %}</a>					
						{% else %}
							<a href="{% url 'new_ecsa_organisation_membership' organisation.id %}" class="btn btn-outline btn-info"><i class="fas fa-users"></i> {% trans "Apply ECSA membership" %}</a>
						{% endif %}
					{% endif %}
					<br/><br/>
					
					{% if organisation.ecsa_member or organisation.ecsa_requested_join %}
					<div class="card-header flex  flex-row-reverse">
						<ul class="nav nav nav-tabs card-header-tabs mr-auto flex-row-reverse">
						  <li class="nav-item">
							<a class="nav-link sub" id="parttab" href="#"
							onClick="$('#one').hide(); $('#two').show()
							$('#parttab').addClass('active')
							$('#desctab').removeClass('active') ">{% trans "ECSA" %}</a>
						  </li>
						  <li class="nav-item">
							<a class="nav-link sub active" id="desctab" href="#"
							onClick="$('#two').hide(); $('#one').show();
							$('#desctab').addClass('active')
							$('#parttab').removeClass('active')">{% trans "Organisation" %}</a>
						  </li>
						</ul>
					  </div>
					  {% endif %}

					<div class="card-text" id="one">

						{% if associatedProjects.all %}
						<h5 class="mt-3">{% trans "Projects" %}</h5>
						{% for project in associatedProjects.all %}
						<a class="badge badge-light pt-1" href="/project/{{project.id}}">{{project|upper}}</a>
						{% endfor %}
						{% endif %}
						{% if associatedResources.all %}
						<h5 class="mt-3">{% trans "Resources" %}</h5>
						{% for resource in associatedResources.all %}
						<a class="badge badge-light pt-1" href="/resource/{{resource.id}}">{{resource|upper}}</a>
						{% endfor %}
						{% endif %}
						{% if members.all %}
						<h5 class="mt-3">{% trans "Members" %}</h5>
						{% for member in members.all %}
						<a class="badge badge-light pt-1" href="/users/{{member.slug}}">{{member.user.name | upper}}</a>
						{% endfor %}
						{% endif %}
						<div class="mt-4">
							{% leaflet_map "map" callback="window.map_init_basic" %}
						</div>
					</div>

					<div class="card-text myhidden" id="two">

						<p><b>{% trans "Member since" %}: </b>{{ organisation.ecsa_member_since | date:"d/m/Y" }}</p>
						<p><b>{% trans "Payment revision" %}: </b>{% if organisation.ecsa_payment_revision %} Yes {% else %} No{% endif %}</p>												
						
						<p><b>{% trans "Reduced fee" %}: </b>{{ organisation.ecsa_reduced_fee }}</p>
						<p><b>{% trans "Old member fee" %}: </b>{{ organisation.ecsa_old_member_fee }}</p>
						<p><b>{% trans "Street" %}: </b>{{ organisation.street }}</p>
						<p><b>{% trans "Postal code" %}: </b>{{ organisation.postal_code }}</p>
						<p><b>{% trans "City" %}: </b>{{ organisation.city }}</p>
						

						<p><b>Billing information</b></p>
						<p><b>{% trans "Billing email" %}: </b>{{ organisation.ecsa_billing_email }}</p>
						<p><b>{% trans "Street" %}: </b>{{ organisation.ecsa_billing_street }}</p>
						<p><b>{% trans "Postal code" %}: </b>{{ organisation.ecsa_billing_postal_code }}</p>
						<p><b>{% trans "City" %}: </b>{{ organisation.ecsa_billing_city }}</p>
						<p><b>{% trans "Country" %}: </b>{{ organisation.ecsa_billing_country }}</p>

						<p><b>{% trans "Occupation" %}: </b>{{ organisation.orgType }}</p>
						<p><b>{% trans "Legal status" %}: </b>{{ organisation.legal_status }}</p>
						{% if organisation.has_vat_number %} <p><b>{% trans "Vat number" %}: </b> organisation.vat_number</p>{% endif %}
					</div>


				</div>
			</div>
		</div><!-- end of card body -->
		{% if user.is_staff or organisation.creator == user or user.id in cooperators %}
			<permissionForm>
				{% csrf_token %}
				{{ permissionForm.usersAllowed | as_crispy_field }}
				{{ permissionForm.selectedUsers | as_crispy_field }}
				{{ permissionForm.usersCollection | as_crispy_field }}
			</permissionForm>
		{% endif %}
		{% if editable %}
		<div class="card-footer">
			<a data-href="{% url 'delete_organisation' organisation.id %}" data-toggle="modal" data-target="#confirm-delete" 
					class="btn btn-outline btn-red float-right ml-2 mt-2">
				<span class="fas fa-trash-alt"></span>&nbsp;{% trans "Delete Organisation" %}
			</a>
			<a href="{% url 'edit_organisation' organisation.id %}" class="btn btn-outline btn-green float-right ml-2 mt-2">
				<i class="fas fa-edit"></i> {% trans "Edit Organisation" %}
			</a>
		</div>
		{% endif %}

	</div>
</div>

{% endblock list_of_items%}

{% block scripts %}
<script>

	$(function () {
		var users = $("#id_usersCollection").val();
		var users = users.split(",");		
		var selectedUsers = $("#id_selectedUsers").val().split(",");
		var i = 0
		var name = ''
		var email = ''
		for (user of users){			
			if (i % 2 == 0){			
				var init = user.indexOf('\'')
				var end = user.indexOf('\'', init+1)
				name = user.substring(init+1,end)
			}else{
				var init = user.indexOf('\'')
				var end = user.indexOf('\'', init+1)
				email = user.substring(init+1,end)
				var found = false;
				for(sel of selectedUsers){
					if(sel.trim() == email.trim()){
					found = true;
					$("#id_usersAllowed").append("<option value='" + email +"' selected> " + name + " </option>");
					}
				}
				if(!found){
					$("#id_usersAllowed").append("<option value='" + email +"'> " + name + " </option>");
				}
			}
			i++
		}

		$('#id_usersAllowed').on('change', function () {
			users = $("#id_usersAllowed option:selected").map(function () {
				return $.trim($(this).val());
			}).get().join(',');
			var idOrganisation = {{organisation.id}};
			var request = $.ajax(
			{
				type: "POST",
				url: "{% url 'allowUserOrganisation' %}",
				data: {
				"organisation_id": idOrganisation,
				"users": users,
				csrfmiddlewaretoken: '{{ csrf_token }}'
				},
				success: function (response) {

				}
			}
		);
		});
	});

	$('#confirm-delete').on('show.bs.modal', function(e) {
		$(this).find('.btn-delete').attr('href', $(e.relatedTarget).data('href'));
	});

	$('#confirm-dropout').on('show.bs.modal', function(e) {
			$(this).find('.btn-dropout').attr('href', $(e.relatedTarget).data('href'));
		});

	var map;
	var marker_layer = new L.marker([50.5, 30.5]);
	function map_init_basic (leafmap, options) {
		map = leafmap;
		map.setView([{{organisation.latitude}}, {{organisation.longitude}}], 12)
		new L.marker([{{organisation.latitude}},{{organisation.longitude}}]).addTo(map);
	}
</script>
{{ permissionForm.media.js }}
{% endblock scripts %}
